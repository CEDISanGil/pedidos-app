<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Devoluciones - CEDI San Gil</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --accent: #E30613;
    --surface: #f5f5f5;
    --card: #ffffff;
    --border: #e0e0e0;
    --text: #111;
    --muted: #888;
    --green: #16a34a;
    --yellow: #b45309;
    --red: #dc2626;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--surface); color: var(--text); font-family: 'Barlow', sans-serif; min-height: 100vh; }

  /* TOPBAR */
  .topbar {
    background: white; border-bottom: 1px solid var(--border);
    padding: 0 28px; display: flex; align-items: center; justify-content: space-between; height: 64px;
  }
  .topbar-left { display: flex; align-items: center; gap: 14px; }
  .logo-sub { font-size: 11px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }
  .topbar-right { display: flex; align-items: center; gap: 10px; }
  .fecha-hoy { font-size: 13px; color: var(--muted); }

  /* MAIN */
  .main { padding: 24px 28px; }

  /* KPIs */
  .kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px; }
  .kpi { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 16px 20px; }
  .kpi-label { font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .kpi-value { font-family: 'Barlow Condensed', sans-serif; font-size: 38px; font-weight: 900; line-height: 1; }
  .kpi-value.red    { color: var(--accent); }
  .kpi-value.yellow { color: #f59e0b; }
  .kpi-value.green  { color: var(--green); }
  .kpi-value.orange { color: #f97316; }

  /* CONTROLES */
  .controls { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
  .filter-group { display: flex; align-items: center; gap: 6px; }
  .filter-group label { font-size: 11px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
  select, input[type="date"] {
    background: white; border: 1px solid var(--border);
    color: var(--text); font-family: 'Barlow', sans-serif; font-size: 14px;
    padding: 8px 12px; border-radius: 8px; outline: none; cursor: pointer;
  }
  select:focus, input:focus { border-color: var(--accent); }

  .btn {
    padding: 9px 16px; border-radius: 8px; border: none; cursor: pointer;
    font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700;
    letter-spacing: 1px; text-transform: uppercase; transition: opacity 0.15s;
  }
  .btn:hover { opacity: 0.82; }
  .btn-excel   { background: #166534; color: white; }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--muted); }
  .btn-refresh { background: white; border: 1px solid var(--border); color: var(--text); }
  .btn-danger  { background: #fef2f2; border: 1px solid #fca5a5; color: var(--red); }
  .btn-danger-solid { background: var(--red); color: white; }
  .ml-auto { margin-left: auto; }

  /* TARJETAS DE RUTA */
  .rutas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 16px; }

  .ruta-card {
    background: white; border: 1.5px solid var(--border);
    border-radius: 14px; overflow: hidden;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    transition: box-shadow 0.2s;
  }
  .ruta-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.10); }
  .ruta-card.estado-pendiente  { border-top: 4px solid #f59e0b; }
  .ruta-card.estado-verificado { border-top: 4px solid var(--green); }

  .ruta-card-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 16px 10px;
  }
  .ruta-nombre { font-family: 'Barlow Condensed', sans-serif; font-size: 28px; font-weight: 900; color: var(--text); }
  .ruta-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }

  .ruta-header-right { display: flex; align-items: center; gap: 8px; }

  .status-chip {
    font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700;
    letter-spacing: 1px; padding: 3px 10px; border-radius: 20px;
  }
  .chip-pendiente  { background: rgba(245,158,11,0.12); color: #b45309; border: 1px solid rgba(245,158,11,0.3); }
  .chip-verificado { background: rgba(22,163,74,0.10);  color: var(--green); border: 1px solid rgba(22,163,74,0.3); }

  /* TABLA INTERNA */
  .ruta-table { width: 100%; border-collapse: collapse; }
  .ruta-table thead th {
    font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted);
    padding: 6px 16px; text-align: left; background: #fafafa;
    border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
  }
  .ruta-table thead th:last-child { text-align: center; }
  .ruta-table tbody tr { border-bottom: 1px solid #f0f0f0; transition: background 0.1s; }
  .ruta-table tbody tr:last-child { border-bottom: none; }
  .ruta-table tbody tr:hover { background: #fafafa; }
  .ruta-table tbody td { padding: 8px 16px; font-size: 13px; color: var(--text); }
  .ruta-table .td-sku   { font-size: 11px; color: var(--muted); white-space: nowrap; }
  .ruta-table .td-prod  { font-weight: 600; }
  .ruta-table .td-qty   { font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 700; text-align: center; color: var(--accent); }
  .ruta-table .td-carg  { font-size: 11px; color: var(--green); text-align: center; }
  .ruta-table .td-del   { text-align: center; }
  .btn-del-row {
    background: none; border: none; cursor: pointer; color: #ccc;
    font-size: 16px; padding: 2px 6px; border-radius: 4px; transition: color 0.15s;
  }
  .btn-del-row:hover { color: var(--red); }

  /* FOOTER TARJETA */
  .ruta-card-footer {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 16px; background: #fafafa; border-top: 1px solid var(--border);
    gap: 8px;
  }
  .footer-left { display: flex; gap: 8px; }

  /* EMPTY / LOADING */
  .empty   { text-align: center; padding: 60px; color: var(--muted); font-size: 14px; }
  .loading { text-align: center; padding: 60px; color: var(--muted); }
  .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 8px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* MODAL CONFIRMACION */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 300; align-items: center; justify-content: center; }
  .modal-overlay.visible { display: flex; }
  .modal { background: white; border-radius: 14px; padding: 28px; width: 380px; max-width: 95vw; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
  .modal-title { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 800; margin-bottom: 8px; }
  .modal-body  { font-size: 14px; color: var(--muted); margin-bottom: 20px; line-height: 1.5; }
  .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }
  .modal-cancel { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 9px 18px; border-radius: 8px; cursor: pointer; font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
  .modal-confirm { background: var(--red); color: white; border: none; padding: 9px 18px; border-radius: 8px; cursor: pointer; font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }

  @media (max-width: 900px) {
    .kpis { grid-template-columns: repeat(2,1fr); }
    .main { padding: 16px; }
    .topbar { padding: 0 16px; }
    .rutas-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <img src="https://cedisangil.github.io/pedidos-app/nuevo-logo.png" alt="CEDI San Gil" style="height:42px;object-fit:contain;">
    <div class="logo-sub">Panel Admin Â· Devoluciones</div>
  </div>
  <div class="topbar-right">
    <div class="fecha-hoy" id="fechaHoy"></div>
    <button class="btn btn-refresh" onclick="cargarDatos()">â†» Actualizar</button>
  </div>
</div>

<div class="main">

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi"><div class="kpi-label">Registros Hoy</div><div class="kpi-value red" id="kpiTotal">â€”</div></div>
    <div class="kpi"><div class="kpi-label">Rutas con DevoluciÃ³n</div><div class="kpi-value orange" id="kpiRutas">â€”</div></div>
    <div class="kpi"><div class="kpi-label">Pendientes</div><div class="kpi-value yellow" id="kpiPendiente">â€”</div></div>
    <div class="kpi"><div class="kpi-label">Verificadas</div><div class="kpi-value green" id="kpiVerificado">â€”</div></div>
  </div>

  <!-- CONTROLES -->
  <div class="controls">
    <div class="filter-group">
      <label>Fecha</label>
      <input type="date" id="filtroFecha" onchange="aplicarFiltros()">
    </div>
    <div class="filter-group">
      <label>Estado</label>
      <select id="filtroEstado" onchange="aplicarFiltros()">
        <option value="">Todos</option>
        <option value="pendiente">Pendiente</option>
        <option value="verificado">Verificado</option>
      </select>
    </div>
    <button class="btn btn-outline" onclick="limpiarFiltros()">Limpiar</button>
    <div class="ml-auto" style="display:flex;gap:8px;">
      <button class="btn btn-danger" onclick="confirmarEliminarTodos()">ðŸ—‘ Eliminar Todo</button>
      <button class="btn btn-excel" onclick="descargarExcel('filtrado')">â†“ Excel</button>
      <button class="btn btn-excel" style="background:#14532d" onclick="descargarExcel('verificado')">â†“ Solo Verificados</button>
    </div>
  </div>

  <!-- TARJETAS -->
  <div class="rutas-grid" id="rutasGrid">
    <div class="loading"><span class="spinner"></span>Cargando...</div>
  </div>

</div>

<!-- MODAL CONFIRMACION -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-title" id="modalTitle">Â¿Confirmar eliminaciÃ³n?</div>
    <div class="modal-body"  id="modalBody"></div>
    <div class="modal-footer">
      <button class="modal-cancel" onclick="cerrarModal()">Cancelar</button>
      <button class="modal-confirm" id="modalConfirmBtn">Eliminar</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://etxtmdljkxdaonyldcmn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0eHRtZGxqa3hkYW9ueWxkY21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NDE1OTAsImV4cCI6MjA3OTAxNzU5MH0.SII1FIsgyuSv1oI1_xJs_MOUvYxNTnJsBEXigbZsosk';

let todosLosDatos = [];
let datosFiltrados = [];

const hoy = new Date();
const hoyISO = hoy.toISOString().split('T')[0];
const hoyStr = `${String(hoy.getDate()).padStart(2,'0')}/${String(hoy.getMonth()+1).padStart(2,'0')}/${hoy.getFullYear()}`;

document.getElementById('fechaHoy').textContent = hoy.toLocaleDateString('es-CO', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
document.getElementById('filtroFecha').value = hoyISO;

async function cargarDatos() {
  document.getElementById('rutasGrid').innerHTML = '<div class="loading"><span class="spinner"></span>Cargando...</div>';
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/devoluciones?order=fecha.desc,hora.desc&limit=2000`,
      { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
    todosLosDatos = await res.json();
    aplicarFiltros();
  } catch(e) {
    document.getElementById('rutasGrid').innerHTML = '<div class="empty">Error al cargar datos.</div>';
  }
}

function parseFecha(iso) {
  if (!iso) return '';
  const [y,m,d] = iso.split('-');
  return `${d}/${m}/${y}`;
}

function aplicarFiltros() {
  const fechaF  = parseFecha(document.getElementById('filtroFecha').value);
  const estadoF = document.getElementById('filtroEstado').value;

  datosFiltrados = todosLosDatos.filter(d => {
    if (fechaF  && d.fecha  !== fechaF)  return false;
    if (estadoF && d.estado !== estadoF) return false;
    return true;
  });

  actualizarKPIs();
  renderTarjetas();
}

function limpiarFiltros() {
  document.getElementById('filtroFecha').value = hoyISO;
  document.getElementById('filtroEstado').value = '';
  aplicarFiltros();
}

function actualizarKPIs() {
  const deHoy = todosLosDatos.filter(d => d.fecha === hoyStr);
  const grupos = agrupar(deHoy);
  const pendientes  = Object.values(grupos).filter(g => g.estado === 'pendiente').length;
  const verificados = Object.values(grupos).filter(g => g.estado === 'verificado').length;
  document.getElementById('kpiTotal').textContent    = deHoy.length;
  document.getElementById('kpiRutas').textContent    = Object.keys(grupos).length;
  document.getElementById('kpiPendiente').textContent  = pendientes;
  document.getElementById('kpiVerificado').textContent = verificados;
}

function agrupar(datos) {
  const g = {};
  datos.forEach(d => {
    const key = `${d.ruta}|${d.fecha}|${d.hora}`;
    if (!g[key]) g[key] = { ruta: d.ruta, fecha: d.fecha, hora: d.hora, estado: d.estado, items: [] };
    if (d.estado === 'pendiente') g[key].estado = 'pendiente';
    g[key].items.push(d);
  });
  return g;
}

function renderTarjetas() {
  const grid = document.getElementById('rutasGrid');
  if (!datosFiltrados.length) {
    grid.innerHTML = '<div class="empty">No se encontraron devoluciones.</div>';
    return;
  }

  const grupos = agrupar(datosFiltrados);
  grid.innerHTML = Object.values(grupos).map(g => {
    const chip = `<span class="status-chip chip-${g.estado}">${g.estado.toUpperCase()}</span>`;
    const filas = g.items.map(item => {
      const cargado = (item.cajas_cargadas || item.botellas_cargadas)
        ? `${item.cajas_cargadas ?? 0}Cj / ${item.botellas_cargadas ?? 0}Bt`
        : 'â€”';
      const devuelto = `${item.cajas_devueltas ?? 0} Cj / ${item.botellas_devueltas ?? 0} Bt`;
      return `<tr>
        <td class="td-sku">${item.sku}</td>
        <td class="td-prod">${item.producto}</td>
        <td class="td-carg">${cargado}</td>
        <td class="td-qty">${devuelto}</td>
        <td class="td-del"><button class="btn-del-row" onclick="confirmarEliminarItem(${item.id}, '${item.producto}')" title="Eliminar">ðŸ—‘</button></td>
      </tr>`;
    }).join('');

    return `<div class="ruta-card estado-${g.estado}">
      <div class="ruta-card-header">
        <div>
          <div class="ruta-nombre">${g.ruta}</div>
          <div class="ruta-meta">${g.fecha} Â· ${g.hora} Â· ${g.items.length} productos</div>
        </div>
        <div class="ruta-header-right">${chip}</div>
      </div>
      <table class="ruta-table">
        <thead><tr>
          <th>SKU</th><th>Producto</th><th>Cargado</th><th>Devuelto</th><th>Del</th>
        </tr></thead>
        <tbody>${filas}</tbody>
      </table>
      <div class="ruta-card-footer">
        <div class="footer-left">
          <button class="btn btn-danger" onclick="confirmarEliminarGrupo('${g.ruta}', '${g.fecha}', '${g.hora}')">ðŸ—‘ Eliminar devoluciÃ³n</button>
          <button class="btn btn-excel" onclick="descargarExcelGrupo('${g.ruta}', '${g.fecha}', '${g.hora}')">â†“ Excel</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€ ELIMINAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let accionPendiente = null;

function confirmarEliminarItem(id, nombre) {
  document.getElementById('modalTitle').textContent = 'Eliminar registro';
  document.getElementById('modalBody').textContent  = `Â¿Eliminar "${nombre}" de la devoluciÃ³n? Esta acciÃ³n no se puede deshacer.`;
  document.getElementById('modalConfirmBtn').onclick = () => eliminarItem(id);
  document.getElementById('modalOverlay').classList.add('visible');
}

function confirmarEliminarGrupo(ruta, fecha, hora) {
  document.getElementById('modalTitle').textContent = `Eliminar devoluciÃ³n ${ruta}`;
  document.getElementById('modalBody').textContent  = `Â¿Eliminar TODA la devoluciÃ³n de la ruta ${ruta} del ${fecha}? Esta acciÃ³n no se puede deshacer.`;
  document.getElementById('modalConfirmBtn').onclick = () => eliminarGrupo(ruta, fecha, hora);
  document.getElementById('modalOverlay').classList.add('visible');
}

function confirmarEliminarTodos() {
  const fechaF = parseFecha(document.getElementById('filtroFecha').value) || hoyStr;
  document.getElementById('modalTitle').textContent = 'Eliminar todas las devoluciones';
  document.getElementById('modalBody').textContent  = `Â¿Eliminar TODAS las devoluciones del ${fechaF}? Esta acciÃ³n no se puede deshacer.`;
  document.getElementById('modalConfirmBtn').onclick = () => eliminarTodos(fechaF);
  document.getElementById('modalOverlay').classList.add('visible');
}

function cerrarModal() {
  document.getElementById('modalOverlay').classList.remove('visible');
}

async function eliminarItem(id) {
  cerrarModal();
  await fetch(`${SUPABASE_URL}/rest/v1/devoluciones?id=eq.${id}`, {
    method: 'DELETE',
    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
  });
  todosLosDatos = todosLosDatos.filter(d => d.id !== id);
  aplicarFiltros();
}

async function eliminarGrupo(ruta, fecha, hora) {
  cerrarModal();
  await fetch(`${SUPABASE_URL}/rest/v1/devoluciones?ruta=eq.${ruta}&fecha=eq.${encodeURIComponent(fecha)}&hora=eq.${encodeURIComponent(hora)}`, {
    method: 'DELETE',
    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
  });
  todosLosDatos = todosLosDatos.filter(d => !(d.ruta === ruta && d.fecha === fecha && d.hora === hora));
  aplicarFiltros();
}

async function eliminarTodos(fecha) {
  cerrarModal();
  await fetch(`${SUPABASE_URL}/rest/v1/devoluciones?fecha=eq.${encodeURIComponent(fecha)}`, {
    method: 'DELETE',
    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
  });
  todosLosDatos = todosLosDatos.filter(d => d.fecha !== fecha);
  aplicarFiltros();
}

// â”€â”€â”€ EXCEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function descargarExcel(tipo) {
  const datos = tipo === 'verificado' ? todosLosDatos.filter(d => d.estado === 'verificado') : datosFiltrados;
  if (!datos.length) { alert('No hay datos para exportar.'); return; }
  exportarExcel(datos, `Devoluciones_${tipo}_${hoyISO}`);
}

function descargarExcelGrupo(ruta, fecha, hora) {
  const datos = todosLosDatos.filter(d => d.ruta === ruta && d.fecha === fecha && d.hora === hora);
  exportarExcel(datos, `Devolucion_${ruta}_${fecha.replace(/\//g,'-')}`);
}

function exportarExcel(datos, nombre) {
  const ws_data = [
    ['Fecha','Hora','Ruta','SKU','Producto','Cajas Cargadas','Botellas Cargadas','Cajas Devueltas','Botellas Devueltas','Estado'],
    ...datos.map(d => [d.fecha, d.hora, d.ruta, d.sku, d.producto,
      d.cajas_cargadas ?? '', d.botellas_cargadas ?? '',
      d.cajas_devueltas ?? 0, d.botellas_devueltas ?? 0,
      d.estado.toUpperCase()])
  ];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  ws['!cols'] = [{wch:12},{wch:10},{wch:10},{wch:10},{wch:30},{wch:14},{wch:16},{wch:14},{wch:16},{wch:12}];
  XLSX.utils.book_append_sheet(wb, ws, 'Devoluciones');
  XLSX.writeFile(wb, nombre + '.xlsx');
}

cargarDatos();
setInterval(cargarDatos, 60000);
</script>
</body>
</html>
