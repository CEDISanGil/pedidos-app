<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Devoluciones - CEDI San Gil</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --accent: #E30613;
    --accent2: #f97316;
    --dark: #111;
    --surface: #1a1a1a;
    --card: #202020;
    --border: #2e2e2e;
    --text: #f0f0f0;
    --muted: #777;
    --green: #22c55e;
    --yellow: #f59e0b;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--dark); color: var(--text); font-family: 'Barlow', sans-serif; min-height: 100vh; }

  /* TOP BAR */
  .topbar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex; align-items: center; justify-content: space-between;
    height: 60px;
  }
  .logo { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; font-weight: 900; letter-spacing: 2px; }
  .logo span { color: var(--accent); }
  .logo-sub { font-size: 11px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-left: 12px; }
  .topbar-right { display: flex; align-items: center; gap: 12px; }
  .fecha-hoy { font-size: 13px; color: var(--muted); }

  /* MAIN LAYOUT */
  .main { padding: 28px 32px; }

  /* KPI CARDS */
  .kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
  .kpi {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 18px 20px;
  }
  .kpi-label { font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
  .kpi-value { font-family: 'Barlow Condensed', sans-serif; font-size: 36px; font-weight: 900; line-height: 1; }
  .kpi-value.red { color: var(--accent); }
  .kpi-value.yellow { color: var(--yellow); }
  .kpi-value.green { color: var(--green); }
  .kpi-value.orange { color: var(--accent2); }

  /* CONTROLES */
  .controls {
    display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .filter-group { display: flex; align-items: center; gap: 8px; }
  .filter-group label { font-size: 12px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
  select, input[type="date"] {
    background: var(--card); border: 1px solid var(--border);
    color: var(--text); font-family: 'Barlow', sans-serif; font-size: 14px;
    padding: 8px 12px; border-radius: 8px; outline: none; cursor: pointer;
  }
  select:focus, input:focus { border-color: var(--accent); }

  .btn {
    padding: 9px 18px; border-radius: 8px; border: none; cursor: pointer;
    font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700;
    letter-spacing: 1px; text-transform: uppercase; transition: opacity 0.2s;
  }
  .btn:hover { opacity: 0.85; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-excel { background: #166534; color: white; }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--muted); }
  .btn-refresh { background: var(--card); border: 1px solid var(--border); color: var(--text); }

  .ml-auto { margin-left: auto; }

  /* TABLA */
  .table-wrap {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden;
  }
  table { width: 100%; border-collapse: collapse; }
  thead { background: #1e1e1e; }
  thead th {
    font-family: 'Barlow Condensed', sans-serif; font-size: 11px;
    letter-spacing: 2px; text-transform: uppercase; color: var(--muted);
    padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border);
    cursor: pointer; user-select: none;
  }
  thead th:hover { color: var(--text); }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(255,255,255,0.03); }
  tbody td { padding: 12px 16px; font-size: 14px; }

  .ruta-cell { font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 800; color: var(--text); }
  .sku-cell { font-family: 'Barlow Condensed', sans-serif; font-size: 12px; color: var(--muted); }
  .prod-cell { font-size: 13px; }
  .qty-cell { font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 700; text-align: center; }
  .qty-cell.red { color: var(--accent); }
  .hora-cell { font-size: 12px; color: var(--muted); }

  .status-chip {
    display: inline-block; font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px; font-weight: 700; letter-spacing: 1px;
    padding: 3px 10px; border-radius: 20px;
  }
  .chip-pendiente { background: rgba(245,158,11,0.15); color: var(--yellow); border: 1px solid rgba(245,158,11,0.3); }
  .chip-verificado { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }

  /* AGRUPADO POR RUTA */
  .group-header {
    background: #1a1a1a; cursor: pointer;
    border-bottom: 2px solid var(--border);
  }
  .group-header td {
    padding: 12px 16px;
    font-family: 'Barlow Condensed', sans-serif;
  }
  .group-header:hover { background: #222; }
  .group-chevron { color: var(--muted); transition: transform 0.2s; margin-right: 8px; }
  .group-chevron.open { transform: rotate(90deg); }

  .loading { text-align: center; padding: 60px; color: var(--muted); }
  .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 8px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .empty { text-align: center; padding: 60px; color: var(--muted); font-size: 14px; }

  /* MODAL DETALLE */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.75); z-index: 200;
    align-items: center; justify-content: center;
  }
  .modal-overlay.visible { display: flex; }
  .modal {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; width: 600px; max-width: 95vw;
    max-height: 85vh; overflow-y: auto;
    padding: 28px;
  }
  .modal-title { font-family: 'Barlow Condensed', sans-serif; font-size: 26px; font-weight: 900; margin-bottom: 4px; }
  .modal-meta { font-size: 13px; color: var(--muted); margin-bottom: 20px; }
  .modal-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  .modal-table th { font-size: 11px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); padding: 8px 0; border-bottom: 1px solid var(--border); text-align: left; }
  .modal-table td { padding: 9px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .modal-table tr:last-child td { border-bottom: none; }
  .modal-close { background: var(--surface); border: 1px solid var(--border); color: var(--muted); padding: 8px 20px; border-radius: 8px; cursor: pointer; font-family: 'Barlow Condensed', sans-serif; font-size: 14px; letter-spacing: 1px; text-transform: uppercase; }
  .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }

  .tag-excel { font-size: 11px; color: #166534; background: rgba(34,197,94,0.1); padding: 2px 8px; border-radius: 6px; margin-left: 8px; }

  @media (max-width: 900px) {
    .kpis { grid-template-columns: repeat(2, 1fr); }
    .main { padding: 16px; }
    .topbar { padding: 0 16px; }
  }
</style>
</head>
<body>

<div class="topbar">
  <div style="display:flex;align-items:center">
    <img src="https://cedisangil.github.io/pedidos-app/nuevo-logo.png" alt="CEDI San Gil" style="height:42px;object-fit:contain;">
    <div class="logo-sub">Panel Admin · Devoluciones</div>
  </div>
  <div class="topbar-right">
    <div class="fecha-hoy" id="fechaHoy"></div>
    <button class="btn btn-refresh" onclick="cargarDatos()">↻ Actualizar</button>
  </div>
</div>

<div class="main">

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi">
      <div class="kpi-label">Total Devoluciones Hoy</div>
      <div class="kpi-value red" id="kpiTotal">—</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Rutas Con Devolución</div>
      <div class="kpi-value orange" id="kpiRutas">—</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Pendientes</div>
      <div class="kpi-value yellow" id="kpiPendiente">—</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Verificadas</div>
      <div class="kpi-value green" id="kpiVerificado">—</div>
    </div>
  </div>

  <!-- CONTROLES -->
  <div class="controls">
    <div class="filter-group">
      <label>Fecha</label>
      <input type="date" id="filtroFecha" onchange="aplicarFiltros()">
    </div>
    <div class="filter-group">
      <label>Ruta</label>
      <select id="filtroRuta" onchange="aplicarFiltros()">
        <option value="">Todas</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Estado</label>
      <select id="filtroEstado" onchange="aplicarFiltros()">
        <option value="">Todos</option>
        <option value="pendiente">Pendiente</option>
        <option value="verificado">Verificado</option>
      </select>
    </div>
    <button class="btn btn-outline" onclick="limpiarFiltros()">Limpiar</button>
    <div class="ml-auto" style="display:flex;gap:10px">
      <button class="btn btn-excel" onclick="descargarExcel('filtrado')">
        ↓ Excel Filtrado
      </button>
      <button class="btn btn-excel" style="background:#14532d" onclick="descargarExcel('verificado')">
        ↓ Excel Verificados
      </button>
    </div>
  </div>

  <!-- TABLA -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Ruta</th>
          <th>Fecha</th>
          <th>Hora</th>
          <th>SKU</th>
          <th>Producto</th>
          <th style="text-align:center">Cjx Carg.</th>
          <th style="text-align:center">Bt Carg.</th>
          <th style="text-align:center">Cjx Dev.</th>
          <th style="text-align:center">Bt Dev.</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="tablaBody">
        <tr><td colspan="10" class="loading"><span class="spinner"></span>Cargando datos...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="cerrarModal(event)">
  <div class="modal" id="modalContent">
    <div class="modal-title" id="modalTitle"></div>
    <div class="modal-meta" id="modalMeta"></div>
    <table class="modal-table">
      <thead><tr><th>SKU</th><th>Producto</th><th>Cjx Carg.</th><th>Bt Carg.</th><th>Cjx Dev.</th><th>Bt Dev.</th></tr></thead>
      <tbody id="modalBody"></tbody>
    </table>
    <div class="modal-footer">
      <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('visible')">Cerrar</button>
      <button class="btn btn-excel" onclick="descargarExcelGrupo()">↓ Excel esta devolución</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://etxtmdljkxdaonyldcmn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0eHRtZGxqa3hkYW9ueWxkY21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NDE1OTAsImV4cCI6MjA3OTAxNzU5MH0.SII1FIsgyuSv1oI1_xJs_MOUvYxNTnJsBEXigbZsosk';

let todosLosDatos = [];
let datosFiltrados = [];
let grupoModal = null;

// Fecha de hoy
const hoy = new Date();
const hoyStr = hoy.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '/');
const hoyISO = hoy.toISOString().split('T')[0];

document.getElementById('fechaHoy').textContent = hoy.toLocaleDateString('es-CO', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
document.getElementById('filtroFecha').value = hoyISO;

async function cargarDatos() {
  document.getElementById('tablaBody').innerHTML = '<tr><td colspan="10" class="loading"><span class="spinner"></span>Cargando...</td></tr>';

  try {
    const res = await fetch(
      `${SUPABASE_URL}/rest/v1/devoluciones?order=fecha.desc,hora.desc&limit=1000`,
      { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
    );
    todosLosDatos = await res.json();

    // Llenar rutas en filtro
    const rutas = [...new Set(todosLosDatos.map(d => d.ruta))].sort();
    const sel = document.getElementById('filtroRuta');
    sel.innerHTML = '<option value="">Todas</option>' + rutas.map(r => `<option>${r}</option>`).join('');

    aplicarFiltros();
  } catch(e) {
    document.getElementById('tablaBody').innerHTML = '<tr><td colspan="10" class="empty">Error al cargar datos.</td></tr>';
  }
}

function parseFecha(iso) {
  // filtroFecha es YYYY-MM-DD, datos tienen DD/MM/YYYY
  if (!iso) return '';
  const [y, m, d] = iso.split('-');
  return `${d}/${m}/${y}`;
}

function aplicarFiltros() {
  const fechaFiltro = parseFecha(document.getElementById('filtroFecha').value);
  const rutaFiltro = document.getElementById('filtroRuta').value;
  const estadoFiltro = document.getElementById('filtroEstado').value;

  datosFiltrados = todosLosDatos.filter(d => {
    if (fechaFiltro && d.fecha !== fechaFiltro) return false;
    if (rutaFiltro && d.ruta !== rutaFiltro) return false;
    if (estadoFiltro && d.estado !== estadoFiltro) return false;
    return true;
  });

  actualizarKPIs();
  renderTabla();
}

function limpiarFiltros() {
  document.getElementById('filtroFecha').value = hoyISO;
  document.getElementById('filtroRuta').value = '';
  document.getElementById('filtroEstado').value = '';
  aplicarFiltros();
}

function actualizarKPIs() {
  const hoySel = parseFecha(document.getElementById('filtroFecha').value) || hoyStr;
  const deHoy = todosLosDatos.filter(d => d.fecha === hoySel);
  const rutasHoy = new Set(deHoy.map(d => d.ruta)).size;
  const pendientes = new Set(deHoy.filter(d => d.estado === 'pendiente').map(d => `${d.ruta}|${d.fecha}|${d.hora}`)).size;
  const verificados = new Set(deHoy.filter(d => d.estado === 'verificado').map(d => `${d.ruta}|${d.fecha}|${d.hora}`)).size;

  document.getElementById('kpiTotal').textContent = deHoy.length;
  document.getElementById('kpiRutas').textContent = rutasHoy;
  document.getElementById('kpiPendiente').textContent = pendientes;
  document.getElementById('kpiVerificado').textContent = verificados;
}

function renderTabla() {
  const tbody = document.getElementById('tablaBody');
  if (datosFiltrados.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" class="empty">No se encontraron registros.</td></tr>';
    return;
  }

  tbody.innerHTML = datosFiltrados.map(d => `
    <tr>
      <td class="ruta-cell">${d.ruta}</td>
      <td class="hora-cell">${d.fecha}</td>
      <td class="hora-cell">${d.hora}</td>
      <td class="sku-cell">${d.sku}</td>
      <td class="prod-cell">${d.producto}</td>
      <td class="qty-cell">${d.cajas_cargadas ?? '—'}</td>
      <td class="qty-cell">${d.botellas_cargadas ?? '—'}</td>
      <td class="qty-cell red">${d.cajas_devueltas ?? 0}</td>
      <td class="qty-cell red">${d.botellas_devueltas ?? 0}</td>
      <td><span class="status-chip chip-${d.estado}">${d.estado.toUpperCase()}</span></td>
    </tr>
  `).join('');
}

function descargarExcel(tipo) {
  let datos = tipo === 'verificado'
    ? todosLosDatos.filter(d => d.estado === 'verificado')
    : datosFiltrados;

  if (datos.length === 0) {
    alert('No hay datos para exportar.');
    return;
  }

  const ws_data = [
    ['Fecha', 'Hora', 'Ruta', 'SKU', 'Producto', 'Cajas Cargadas', 'Botellas Cargadas', 'Cajas Devueltas', 'Botellas Devueltas', 'Estado'],
    ...datos.map(d => [
      d.fecha, d.hora, d.ruta, d.sku, d.producto,
      d.cajas_cargadas ?? '', d.botellas_cargadas ?? '',
      d.cajas_devueltas ?? 0, d.botellas_devueltas ?? 0,
      d.estado.toUpperCase()
    ])
  ];

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);

  // Anchos de columnas
  ws['!cols'] = [{ wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 30 }, { wch: 15 }, { wch: 16 }, { wch: 15 }, { wch: 16 }, { wch: 12 }];

  XLSX.utils.book_append_sheet(wb, ws, 'Devoluciones');

  const fecha = new Date().toLocaleDateString('es-CO').replace(/\//g, '-');
  XLSX.writeFile(wb, `Devoluciones_${tipo}_${fecha}.xlsx`);
}

function descargarExcelGrupo() {
  if (!grupoModal) return;
  const { ruta, fecha, hora, items } = grupoModal;

  const ws_data = [
    ['Fecha', 'Hora', 'Ruta', 'SKU', 'Producto', 'Cajas Cargadas', 'Botellas Cargadas', 'Cajas Devueltas', 'Botellas Devueltas', 'Estado'],
    ...items.map(d => [
      d.fecha, d.hora, d.ruta, d.sku, d.producto,
      d.cajas_cargadas ?? '', d.botellas_cargadas ?? '',
      d.cajas_devueltas ?? 0, d.botellas_devueltas ?? 0,
      d.estado.toUpperCase()
    ])
  ];

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  ws['!cols'] = [{ wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 30 }, { wch: 15 }, { wch: 16 }, { wch: 15 }, { wch: 16 }, { wch: 12 }];
  XLSX.utils.book_append_sheet(wb, ws, 'Devolucion');
  XLSX.writeFile(wb, `Devolucion_${ruta}_${fecha.replace(/\//g, '-')}.xlsx`);
}

function cerrarModal(e) {
  if (e.target === document.getElementById('modalOverlay')) {
    document.getElementById('modalOverlay').classList.remove('visible');
  }
}

cargarDatos();
setInterval(cargarDatos, 60000); // Auto-refresh cada minuto
</script>
</body>
</html>
