<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Panel Inventario - CEDI San Gil</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #cc0000 0%, #8b0000 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(204, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .logo {
            width: 150px;
            margin: 20px auto;
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #cc0000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .stat-card h3 {
            color: #fbbc04;
            font-size: 3em;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #cccccc;
            font-size: 1.1em;
        }

        .section {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 2px solid #cc0000;
        }

        .section h2 {
            color: #cc0000;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #fbbc04 0%, #e6a800 100%);
            color: #000000;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #cc0000 0%, #8b0000 100%);
            color: #ffffff;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: #ffffff;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
            color: #ffffff;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(251, 188, 4, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: #cc0000;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            font-weight: bold;
            color: #ffffff;
        }

        tbody tr:hover {
            background: #2a2a2a;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #fbbc04;
            font-weight: bold;
            font-size: 1.1em;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid #cc0000;
            border-radius: 8px;
            font-size: 1em;
            background: #1a1a1a;
            color: #ffffff;
            font-family: monospace;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #fbbc04;
            box-shadow: 0 0 10px rgba(251, 188, 4, 0.3);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .alert-success {
            background: #2d5016;
            border: 2px solid #4caf50;
            color: #4caf50;
        }

        .alert-error {
            background: #5c1a1a;
            border: 2px solid #cc0000;
            color: #ff6b6b;
        }

        .alert-info {
            background: #1a3a5c;
            border: 2px solid #2196f3;
            color: #64b5f6;
        }

        .info-box {
            background: #1a3a5c;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #64b5f6;
        }

        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .buttons-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Panel de Control - Inventario</h1>
            <p>Consolidador y Gestor de Inventario</p>
            <img src="https://cedisangil.github.io/pedidos-app/Logo_Coca_cola.jpg" alt="Coca-Cola" class="logo">
        </div>

        <div id="alertContainer"></div>

        <!-- ESTAD√çSTICAS -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="totalRegistros">0</h3>
                <p>Registros Hoy</p>
            </div>
            <div class="stat-card">
                <h3 id="totalCajas">0</h3>
                <p>Total Cajas</p>
            </div>
            <div class="stat-card">
                <h3 id="totalBotellas">0</h3>
                <p>Total Botellas</p>
            </div>
            <div class="stat-card">
                <h3 id="diferenciasActivas">0</h3>
                <p>Diferencias Activas</p>
            </div>
        </div>

        <!-- FASE 1: CONTEO DIARIO -->
        <div class="section">
            <h2>üìù Fase 1: Conteo Diario</h2>
            
            <div class="buttons-grid">
                <button class="btn btn-primary" onclick="descargarConteo()">
                    üì• Descargar Conteo del D√≠a
                </button>
                <button class="btn btn-secondary" onclick="cargarDatos()">
                    üîÑ Actualizar Datos
                </button>
                <button class="btn btn-danger" onclick="limpiarConteo()">
                    üóëÔ∏è Limpiar Conteo
                </button>
            </div>

            <div class="table-container">
                <table id="tablaConteo">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Tipo</th>
                            <th>Hora</th>
                        </tr>
                    </thead>
                    <tbody id="conteoBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                                No hay datos de conteo para hoy
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- FASE 2: CARGAR DIFERENCIAS -->
        <div class="section">
            <h2>üìã Fase 2: Cargar Diferencias</h2>
            
            <div class="info-box">
                <strong>üìå Formato requerido (copiar y pegar desde Excel):</strong>
                <ul>
                    <li>Columna 1: <strong>SKU</strong></li>
                    <li>Columna 2: <strong>Producto</strong></li>
                    <li>Columna 3: <strong>Cantidad Sistema</strong></li>
                    <li>Columna 4: <strong>Cantidad F√≠sica</strong> (lo que cont√≥ Ivan)</li>
                </ul>
                <p style="margin-top: 10px;">Ejemplo:</p>
                <code style="background: #000; padding: 10px; display: block; margin-top: 5px; border-radius: 5px;">
                    160538	12 PACK POWERADE SURTIDO 500ML	50	48<br>
                    56723	12PACK (6QTC + 6SP 1.5LT)	30	35
                </code>
            </div>

            <div class="form-group">
                <label for="diferenciasInput">Pega aqu√≠ los datos de diferencias:</label>
                <textarea id="diferenciasInput" placeholder="Pega aqu√≠ las l√≠neas copiadas de Excel..."></textarea>
            </div>

            <button class="btn btn-success" onclick="cargarDiferencias()">
                ‚¨ÜÔ∏è Cargar Diferencias para Verificaci√≥n
            </button>
        </div>

        <!-- FASE 3: VERIFICACIONES -->
        <div class="section">
            <h2>‚úÖ Fase 3: Verificaciones</h2>
            
            <div class="buttons-grid">
                <button class="btn btn-primary" onclick="descargarVerificaciones()">
                    üì• Descargar Verificaciones
                </button>
                <button class="btn btn-success" onclick="cargarDatos()">
                    üîÑ Actualizar Verificaciones
                </button>
            </div>

            <div class="table-container">
                <table id="tablaVerificaciones">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Producto</th>
                            <th>Sistema</th>
                            <th>Contado</th>
                            <th>Diferencia</th>
                            <th>Cantidad Correcta</th>
                            <th>Fecha Verificaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="verificacionesBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                No hay verificaciones para mostrar
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- GESTI√ìN DE DATOS -->
        <div class="section">
            <h2>üîß Gesti√≥n de Datos</h2>
            
            <div class="buttons-grid">
                <button class="btn btn-danger" onclick="limpiarDiferenciasVerificadas()">
                    üóëÔ∏è Limpiar Diferencias Verificadas
                </button>
                <button class="btn btn-danger" onclick="limpiarTodo()">
                    ‚ö†Ô∏è Limpiar TODO
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://etxtmdljkxdaonyldcmn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0eHRtZGxqa3hkYW9ueWxkY21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NDE1OTAsImV4cCI6MjA3OTAxNzU5MH0.SII1FIsgyuSv1oI1_xJs_MOUvYxNTnJsBEXigbZsosk';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let datosConteo = [];
        let datosVerificaciones = [];

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
            
            // Auto-actualizar cada 30 segundos
            setInterval(cargarDatos, 30000);
        });

        async function cargarDatos() {
            await cargarConteo();
            await cargarVerificacionesCompletas();
            await actualizarEstadisticas();
        }

        async function cargarConteo() {
            try {
                const hoy = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabase
                    .from('inventario_diario')
                    .select('*')
                    .eq('fecha', hoy)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                datosConteo = data || [];
                mostrarConteo();
            } catch (error) {
                console.error('Error al cargar conteo:', error);
                mostrarAlerta('Error al cargar datos de conteo', 'error');
            }
        }

        function mostrarConteo() {
            const tbody = document.getElementById('conteoBody');
            
            if (datosConteo.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">No hay datos de conteo para hoy</td></tr>';
                return;
            }

            tbody.innerHTML = datosConteo.map(registro => `
                <tr>
                    <td>${registro.sku}</td>
                    <td>${registro.producto}</td>
                    <td style="color: #fbbc04; font-weight: bold;">${registro.cantidad}</td>
                    <td style="color: ${registro.tipo === 1 ? '#4caf50' : '#2196f3'};">
                        ${registro.tipo === 1 ? 'üü¢ Caja' : 'üîµ Botella'}
                    </td>
                    <td>${new Date(registro.created_at).toLocaleTimeString('es-CO')}</td>
                </tr>
            `).join('');
        }

        async function cargarVerificacionesCompletas() {
            try {
                const hoy = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabase
                    .from('verificaciones_inventario')
                    .select(`
                        *,
                        diferencias_inventario (
                            sku,
                            producto,
                            cantidad_sistema,
                            cantidad_fisica
                        )
                    `)
                    .gte('fecha_verificacion', hoy + 'T00:00:00')
                    .order('fecha_verificacion', { ascending: false });

                if (error) throw error;

                datosVerificaciones = data || [];
                mostrarVerificaciones();
            } catch (error) {
                console.error('Error al cargar verificaciones:', error);
            }
        }

        function mostrarVerificaciones() {
            const tbody = document.getElementById('verificacionesBody');
            
            if (datosVerificaciones.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">No hay verificaciones para mostrar</td></tr>';
                return;
            }

            tbody.innerHTML = datosVerificaciones.map(verif => {
                const dif = verif.diferencias_inventario;
                const diferencia = dif.cantidad_fisica - dif.cantidad_sistema;
                
                return `
                    <tr>
                        <td>${dif.sku}</td>
                        <td>${dif.producto}</td>
                        <td>${dif.cantidad_sistema}</td>
                        <td>${dif.cantidad_fisica}</td>
                        <td style="color: ${diferencia >= 0 ? '#4caf50' : '#ff6b6b'}; font-weight: bold;">
                            ${diferencia > 0 ? '+' : ''}${diferencia}
                        </td>
                        <td style="color: #fbbc04; font-weight: bold; font-size: 1.1em;">
                            ${verif.cantidad_correcta}
                        </td>
                        <td>${new Date(verif.fecha_verificacion).toLocaleString('es-CO')}</td>
                    </tr>
                `;
            }).join('');
        }

        async function actualizarEstadisticas() {
            // Total registros
            document.getElementById('totalRegistros').textContent = datosConteo.length;
            
            // Total cajas
            const totalCajas = datosConteo
                .filter(r => r.tipo === 1)
                .reduce((sum, r) => sum + r.cantidad, 0);
            document.getElementById('totalCajas').textContent = totalCajas;
            
            // Total botellas
            const totalBotellas = datosConteo
                .filter(r => r.tipo === 2)
                .reduce((sum, r) => sum + r.cantidad, 0);
            document.getElementById('totalBotellas').textContent = totalBotellas;
            
            // Diferencias activas
            try {
                const hoy = new Date().toISOString().split('T')[0];
                const { data, error } = await supabase
                    .from('diferencias_inventario')
                    .select('id')
                    .eq('fecha', hoy)
                    .eq('verificado', false);
                
                if (!error) {
                    document.getElementById('diferenciasActivas').textContent = data?.length || 0;
                }
            } catch (error) {
                console.error('Error al contar diferencias:', error);
            }
        }

        async function descargarConteo() {
            if (datosConteo.length === 0) {
                mostrarAlerta('No hay datos de conteo para descargar', 'info');
                return;
            }

            try {
                // Preparar datos para Excel
                const datosExcel = datosConteo.map(registro => ({
                    'SKU': registro.sku,
                    'Producto': registro.producto,
                    'Cantidad': registro.cantidad,
                    'Tipo': registro.tipo === 1 ? 'Caja' : 'Botella',
                    'Hora': new Date(registro.created_at).toLocaleTimeString('es-CO')
                }));

                // Crear libro de Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(datosExcel);
                
                // Ajustar anchos de columna
                ws['!cols'] = [
                    { wch: 10 },  // SKU
                    { wch: 40 },  // Producto
                    { wch: 10 },  // Cantidad
                    { wch: 10 },  // Tipo
                    { wch: 12 }   // Hora
                ];

                XLSX.utils.book_append_sheet(wb, ws, 'Conteo');
                
                // Descargar
                const fecha = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Inventario_Conteo_${fecha}.xlsx`);
                
                mostrarAlerta('‚úÖ Archivo descargado correctamente', 'success');
            } catch (error) {
                console.error('Error al descargar:', error);
                mostrarAlerta('‚ùå Error al generar archivo', 'error');
            }
        }

        async function cargarDiferencias() {
            const input = document.getElementById('diferenciasInput').value.trim();
            
            if (!input) {
                mostrarAlerta('Por favor pega los datos de diferencias', 'error');
                return;
            }

            try {
                // Parsear l√≠neas
                const lineas = input.split('\n').filter(l => l.trim());
                const diferencias = [];

                for (const linea of lineas) {
                    // Separar por tabulaci√≥n o m√∫ltiples espacios
                    const partes = linea.split(/\t+|\s{2,}/).filter(p => p.trim());
                    
                    if (partes.length >= 4) {
                        diferencias.push({
                            sku: partes[0].trim(),
                            producto: partes[1].trim(),
                            cantidad_sistema: parseInt(partes[2]),
                            cantidad_fisica: parseInt(partes[3])
                        });
                    }
                }

                if (diferencias.length === 0) {
                    mostrarAlerta('No se pudieron procesar los datos. Verifica el formato.', 'error');
                    return;
                }

                // Insertar en base de datos
                const { data, error } = await supabase
                    .from('diferencias_inventario')
                    .insert(diferencias);

                if (error) throw error;

                mostrarAlerta(`‚úÖ Se cargaron ${diferencias.length} diferencias correctamente`, 'success');
                document.getElementById('diferenciasInput').value = '';
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('‚ùå Error al cargar diferencias: ' + error.message, 'error');
            }
        }

        async function descargarVerificaciones() {
            if (datosVerificaciones.length === 0) {
                mostrarAlerta('No hay verificaciones para descargar', 'info');
                return;
            }

            try {
                const datosExcel = datosVerificaciones.map(verif => {
                    const dif = verif.diferencias_inventario;
                    const diferencia = dif.cantidad_fisica - dif.cantidad_sistema;
                    
                    return {
                        'SKU': dif.sku,
                        'Producto': dif.producto,
                        'Cantidad Sistema': dif.cantidad_sistema,
                        'Cantidad F√≠sica': dif.cantidad_fisica,
                        'Diferencia': diferencia,
                        'Cantidad Correcta': verif.cantidad_correcta,
                        'Fecha Verificaci√≥n': new Date(verif.fecha_verificacion).toLocaleString('es-CO')
                    };
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(datosExcel);
                
                ws['!cols'] = [
                    { wch: 10 },  // SKU
                    { wch: 40 },  // Producto
                    { wch: 12 },  // Sistema
                    { wch: 12 },  // F√≠sica
                    { wch: 10 },  // Diferencia
                    { wch: 15 },  // Correcta
                    { wch: 20 }   // Fecha
                ];

                XLSX.utils.book_append_sheet(wb, ws, 'Verificaciones');
                
                const fecha = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Inventario_Verificaciones_${fecha}.xlsx`);
                
                mostrarAlerta('‚úÖ Archivo descargado correctamente', 'success');
            } catch (error) {
                console.error('Error al descargar:', error);
                mostrarAlerta('‚ùå Error al generar archivo', 'error');
            }
        }

        async function limpiarConteo() {
            if (!confirm('¬øEst√°s seguro de limpiar todos los registros de conteo de hoy?')) return;

            try {
                const hoy = new Date().toISOString().split('T')[0];
                
                const { error } = await supabase
                    .from('inventario_diario')
                    .delete()
                    .eq('fecha', hoy);

                if (error) throw error;

                mostrarAlerta('üóëÔ∏è Conteo limpiado correctamente', 'success');
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('‚ùå Error al limpiar: ' + error.message, 'error');
            }
        }

        async function limpiarDiferenciasVerificadas() {
            if (!confirm('¬øEliminar todas las diferencias que ya fueron verificadas?')) return;

            try {
                const { error } = await supabase
                    .from('diferencias_inventario')
                    .delete()
                    .eq('verificado', true);

                if (error) throw error;

                mostrarAlerta('üóëÔ∏è Diferencias verificadas eliminadas', 'success');
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('‚ùå Error al limpiar: ' + error.message, 'error');
            }
        }

        async function limpiarTodo() {
            if (!confirm('‚ö†Ô∏è ADVERTENCIA: Esto eliminar√° TODOS los datos de inventario, diferencias y verificaciones. ¬øContinuar?')) return;
            if (!confirm('¬øEst√°s COMPLETAMENTE seguro? Esta acci√≥n no se puede deshacer.')) return;

            try {
                // Limpiar en orden debido a las foreign keys
                await supabase.from('verificaciones_inventario').delete().neq('id', 0);
                await supabase.from('diferencias_inventario').delete().neq('id', 0);
                await supabase.from('inventario_diario').delete().neq('id', 0);

                mostrarAlerta('üóëÔ∏è Todos los datos han sido eliminados', 'success');
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('‚ùå Error al limpiar: ' + error.message, 'error');
            }
        }

        function mostrarAlerta(mensaje, tipo) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo}`;
            alert.textContent = mensaje;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>
